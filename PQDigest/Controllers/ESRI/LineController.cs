//******************************************************************************************************
//  LineController.cs - Gbtc
//
//  Copyright © 2020, Grid Protection Alliance.  All Rights Reserved.
//
//  Licensed to the Grid Protection Alliance (GPA) under one or more contributor license agreements. See
//  the NOTICE file distributed with this work for additional information regarding copyright ownership.
//  The GPA licenses this file to you under the MIT License (MIT), the "License"; you may not use this
//  file except in compliance with the License. You may obtain a copy of the License at:
//
//      http://opensource.org/licenses/MIT
//
//  Unless agreed to in writing, the subject software distributed under the License is distributed on an
//  "AS-IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. Refer to the
//  License for the specific language governing permissions and limitations.
//
//  Code Modification History:
//  ----------------------------------------------------------------------------------------------------
//  07/22/2020 - Billy Ernest
//       Generated original version of source code.
//
//******************************************************************************************************

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using FaultData.DataAnalysis;
using Gemstone.Data;
using Gemstone.Data.Model;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Configuration;
using OpenXDA.Model;
using PQDigest.Models;
using System.Net.Http;
using Gemstone.Numeric.Random;
using System.Data;
using System.Net;
using System.IO;

namespace PQDigest.Controllers
{
    [Route("api/ESRI/[controller]")]
    [ApiController]
    public class LineController : ControllerBase
    {
        private readonly IConfiguration m_configuration;

        public LineController(IConfiguration configuration)
        {
            m_configuration = configuration;
        }

        public class PostData
        {
            public int[] Meters { get; set; }
        }

        [HttpPost("")]
        public ActionResult Post([FromBody] PostData postData) {
            using (AdoDataConnection xdaConnection = new AdoDataConnection(m_configuration["OpenXDA:ConnectionString"], m_configuration["OpenXDA:DataProviderString"]))
            {
#if DEBUG
                return Ok("{\"type\":\"FeatureCollection\",\"crs\":{\"type\":\"name\",\"properties\":{\"name\":\"EPSG:4326\"}},\"features\":[{\"type\":\"Feature\",\"geometry\":{\"type\":\"LineString\",\"coordinates\":[[-84.958452440077252,35.041838684337058],[-84.958760440582452,35.041251684344616],[-84.95746641254506,35.039691505730559],[-84.955980555223306,35.037813913800065],[-84.957439250171035,35.037032403912022],[-84.959272449722732,35.036050247511355],[-84.962029244482522,35.034573266696732],[-84.96482477464275,35.033075532908711],[-84.967542904840371,35.031619529370531],[-84.969166190041136,35.030749940795495],[-84.972636545475311,35.028890744375687],[-84.97463752366302,35.027818663199369],[-84.977505965744783,35.026281703070119],[-84.980528206254874,35.024662198159888],[-84.982682877804208,35.023507504624696],[-84.984885951130821,35.02232679633331],[-84.987481444022507,35.021628638373585],[-84.989306589833078,35.021137654125766],[-84.993528148522813,35.020001877004752],[-84.995162781391699,35.019562043460319],[-84.999177867693561,35.018481580715822],[-85.001193306009554,35.017939163034065],[-85.004414777357141,35.01707207751361],[-85.006858606229599,35.016414231174963],[-85.008382010963331,35.016004120265741],[-85.010778168035628,35.015359008129238],[-85.013206024745898,35.014705303837808],[-85.01604640722249,35.013940448541774],[-85.01869632306223,35.013226809306694],[-85.020632161427798,35.012705429547104],[-85.023234396391842,35.012004508884871],[-85.024752810728216,35.011595486626007],[-85.027990850388591,35.010943393234569]]},\"properties\":{\"LINENAME\":\"L5281\"}},{\"type\":\"Feature\",\"geometry\":{\"type\":\"LineString\",\"coordinates\":[[-85.069465265739453,35.078331212905454],[-85.068835496858256,35.077459896568527],[-85.068359823145045,35.076692595493157],[-85.068590720761179,35.075489615774075],[-85.068799058114649,35.074404139046159],[-85.068999578418016,35.073359366427425],[-85.069205300998576,35.072287457268821],[-85.069418830837336,35.071174842016333],[-85.069621938646691,35.070116500428618],[-85.069871909753189,35.068813926329533],[-85.070114062465393,35.06755205627303],[-85.070140344018952,35.066709959501402],[-85.068428271503706,35.066634633895895],[-85.06680016559919,35.066642733309685],[-85.065196294431857,35.06666435858665],[-85.063557245509159,35.066669984188074],[-85.061866467437838,35.066770338423389],[-85.059630948682184,35.067428663155908],[-85.057209362217421,35.068212689765595],[-85.056283829380789,35.069411486323027],[-85.05535975058261,35.070700347301063],[-85.054668388379099,35.071663988571082],[-85.053709047900171,35.072942799176715],[-85.052677189424642,35.074364993301892],[-85.05160792290026,35.075130576394457],[-85.049900416111242,35.076316747342169],[-85.048742874771349,35.077214553009512],[-85.046812668730553,35.077024788154965],[-85.046085659008128,35.07680929918893],[-85.043617188134462,35.075749179007119],[-85.040864248332539,35.076187528571936],[-85.038943917016084,35.07623475097359],[-85.03744241085478,35.07619815477473],[-85.037494778582968,35.074725920786136],[-85.037211766103425,35.072334083299154],[-85.036921152827773,35.0700687753057],[-85.03673594639055,35.068646953936863],[-85.036459587656296,35.066316932223558],[-85.03627138277227,35.064788032068307],[-85.036039004735812,35.062830510157589],[-85.035777257011716,35.060610557520995],[-85.035563714630655,35.058842149768296],[-85.035292846019999,35.056360184710201],[-85.03501306375783,35.053818083243947],[-85.034898963849088,35.052785634315029],[-85.034719133113356,35.05116893231736],[-85.034512241213051,35.049316871546509],[-85.034381986482018,35.048108331202961],[-85.034294484035712,35.047149146639711]]},\"properties\":{\"LINENAME\":\"L5281\"}},{\"type\":\"Feature\",\"geometry\":{\"type\":\"LineString\",\"coordinates\":[[-85.069734187946551,35.07818738453674],[-85.069020379965536,35.077361015527366],[-85.068359823145045,35.076692595493157],[-85.068590720761179,35.075489615774075],[-85.068799058114649,35.074404139046159],[-85.068999578418016,35.073359366427425],[-85.069205300998576,35.072287457268821],[-85.069418830837336,35.071174842016333],[-85.069621938646691,35.070116500428618],[-85.069871909753189,35.068813926329533],[-85.070114062465393,35.06755205627303],[-85.07041064519133,35.066711645942178],[-85.072315158259769,35.06660304734654],[-85.073738437158511,35.06658349536351],[-85.075451141176927,35.066581341539639],[-85.076803635752455,35.066570655948141],[-85.079215842002057,35.066548442731296],[-85.080422532474898,35.066546361623558],[-85.082349347762673,35.066631496463614],[-85.083850759382287,35.066732554465574],[-85.084702596576818,35.066805435242578],[-85.086291691931052,35.066922579088377],[-85.088780429386929,35.067087420770278],[-85.090330674089756,35.067210139507552],[-85.092385859853039,35.067401645171671],[-85.091971631971063,35.067346588198276],[-85.091934480423035,35.067317684615766],[-85.092443021068945,35.067374860479745],[-85.092915765282555,35.06654416065934],[-85.093904255252511,35.064429933398671],[-85.095538079248527,35.060935187029443],[-85.097711046283024,35.059137425035459],[-85.100340293334042,35.056962009899209],[-85.103270852834001,35.054537079472468],[-85.10610552148087,35.053225186245356],[-85.110616779509172,35.051137134083582],[-85.111890298142484,35.050031035301629],[-85.113566755466223,35.047314054740831],[-85.114884681653209,35.045170170022779],[-85.117441904108674,35.041015834397491],[-85.119353589001975,35.03790684886205],[-85.121087562869604,35.035089405181296],[-85.122107881803416,35.03343143976101],[-85.123707927820007,35.030831287847136],[-85.126394765814126,35.028828559281131],[-85.129354360014517,35.026622334247101],[-85.130831008692923,35.02389021307593],[-85.13224299344941,35.021277533927559],[-85.133761334343603,35.018467855272682],[-85.135364223966207,35.015501492939563],[-85.135859759969136,35.012536825048841],[-85.137521364234246,35.009823486716179],[-85.141200438134945,35.008095377566981],[-85.14556588329522,35.007413317759912],[-85.149556951920786,35.006789601947759],[-85.15300368832979,35.006825457722222],[-85.156215982650167,35.006861437035262],[-85.156939591983246,35.005245719505083],[-85.158023994835105,35.002824281489566],[-85.158912687628202,35.000839739761545],[-85.159650393805208,34.999192282822662],[-85.16018767225232,34.996968103737366],[-85.160791065848358,34.99649890212671]]},\"properties\":{\"LINENAME\":\"L5281\"}}]}");
#else


                DataTable lines = xdaConnection.RetrieveData(@"
                    select 
	                    *
                    From 
	                    Asset
                    WHERE
	                    ID IN (SELECT AssetID FROM MeterAsset WHERE MeterID IN ( "+ string.Join(",", postData.Meters) + @"))
                ", null);

                string queryString = $"f=geojson&returnGeometry=true&outfiels=LINENAME&where=UPPER(LINENAME) in ({ string.Join(",", lines.Select().Select(dr => dr["AssetKey"].ToString())) })";
                WebRequest webRequest = WebRequest.Create($"{m_configuration["ARCGIS:Proxy"]}?{m_configuration["ARCGIS:Host"]}{m_configuration["ARCGIS:LineEndpoint"]}");
                HttpWebResponse response = (HttpWebResponse)webRequest.GetResponse();
                Stream dataStream = response.GetResponseStream();
                StreamReader reader = new StreamReader(dataStream);
                string responseData = reader.ReadToEnd();

                reader.Close();
                dataStream.Close();
                response.Close();

                return Ok(responseData);

#endif
            }
        }

    }
}
